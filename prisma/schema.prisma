generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model AppSettings {
  id                   String            @id @default(cuid())
  shop                 String            @unique @db.VarChar(255)
  defaultPricingMode   String            @default("markup") @db.VarChar(50)
  defaultMarkupAmount  Float             @default(0)
  defaultMultiplier    Float             @default(1)
  autoSyncEnabled      Boolean           @default(false)
  syncFrequency        String?           @db.VarChar(50)
  authorizedSources    String?           @default("[]") @db.Text
  termsAccepted        Boolean           @default(false)
  termsAcceptedAt      DateTime?
  defaultCollectionId  String?           @db.VarChar(255)
  defaultTags          String?           @default("kopy-product") @db.Text
  autoPublish          Boolean           @default(false)
  priceRoundingEnabled Boolean           @default(false)
  defaultRoundingValue String?           @default("0.99") @db.VarChar(10)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  importedProducts     ImportedProduct[]
}

model ImportedProduct {
  id                   String           @id @default(cuid())
  shop                 String           @db.VarChar(255)
  sourceShop           String           @db.VarChar(255)
  sourceProductId      String           @db.VarChar(255)
  sourceProductHandle  String?          @db.VarChar(255)
  sourceProductUrl     String           @db.VarChar(500)
  destinationProductId String           @db.VarChar(255)
  destinationHandle    String?          @db.VarChar(255)
  title                String           @db.VarChar(500)
  status               String           @default("active") @db.VarChar(50)
  pricingMode          String           @db.VarChar(50)
  markupAmount         Float?
  multiplier           Float?
  productImage         String?          @db.VarChar(1000)
  price                Float?
  lastSyncAt           DateTime?
  syncEnabled          Boolean          @default(false)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  settings             AppSettings      @relation(fields: [shop], references: [shop], onDelete: Cascade)
  variants             VariantMapping[]

  @@index([shop])
  @@index([shop, sourceProductId])
  @@index([destinationProductId])
}

model VariantMapping {
  id                   String          @id @default(cuid())
  importedProductId    String          @db.VarChar(255)
  sourceVariantId      String          @db.VarChar(255)
  destinationVariantId String          @db.VarChar(255)
  title                String?         @db.VarChar(255)
  sourcePrice          Float
  destinationPrice     Float
  sku                  String?         @db.VarChar(255)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  importedProduct      ImportedProduct @relation(fields: [importedProductId], references: [id], onDelete: Cascade)

  @@unique([importedProductId, sourceVariantId])
  @@index([destinationVariantId])
}

model BulkImportJob {
  id                String    @id @default(cuid())
  shop              String    @db.VarChar(255)
  sourceShop        String    @db.VarChar(255)
  sourceShopUrl     String    @db.VarChar(500)
  pricingMode       String    @db.VarChar(50)
  markupAmount      Float?
  multiplier        Float?
  status            String    @default("ACTIVE") @db.VarChar(50)
  collectionId      String?   @db.VarChar(255)
  productIds        String    @db.Text
  totalProducts     Int
  processedProducts Int       @default(0)
  successfulImports Int       @default(0)
  failedImports     Int       @default(0)
  jobStatus         String    @default("pending") @db.VarChar(50)
  errors            String?   @default("[]") @db.Text
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([shop])
  @@index([jobStatus])
}
